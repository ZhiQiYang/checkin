<!-- templates/admin.html -->
{% extends "base.html" %}

{% block title %}ç®¡ç†é¢æ¿{% endblock %}

{% block extra_css %}
<style>
    .card {
        margin-bottom: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .card-header {
        background-color: #f8f9fa;
        font-weight: bold;
    }
    .status-badge {
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 0.8em;
        font-weight: bold;
    }
    .status-good {
        background-color: #d4edda;
        color: #155724;
    }
    .status-warning {
        background-color: #fff3cd;
        color: #856404;
    }
    .status-danger {
        background-color: #f8d7da;
        color: #721c24;
    }
    .dashboard-item {
        text-align: center;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 15px;
        background-color: #f8f9fa;
    }
    .dashboard-value {
        font-size: 2em;
        font-weight: bold;
        color: #007bff;
    }
    .dashboard-label {
        font-size: 0.9em;
        color: #6c757d;
    }
    .action-button {
        margin-top: 10px;
    }
    .system-info {
        font-size: 0.9em;
        color: #6c757d;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <h1 class="mb-4">ğŸ”§ ç³»çµ±ç®¡ç†é¢æ¿</h1>
    
    <div class="alert alert-info">
        <strong>ç®¡ç†å“¡æ³¨æ„ï¼š</strong> æ­¤é é¢åƒ…ä¾›ç³»çµ±ç®¡ç†å“¡ä½¿ç”¨ï¼Œè«‹å‹¿åˆ†äº«çµ¦ä»–äººã€‚
    </div>
    
    <div class="row">
        <!-- ç³»çµ±ç‹€æ…‹èˆ‡æ‘˜è¦ -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    ç³»çµ±ç‹€æ…‹
                    <span id="system-status" class="status-badge status-good float-right">æ­£å¸¸</span>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="dashboard-item">
                                <div id="checkin-count" class="dashboard-value">-</div>
                                <div class="dashboard-label">æ‰“å¡ç¸½æ•¸</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="dashboard-item">
                                <div id="today-count" class="dashboard-value">-</div>
                                <div class="dashboard-label">ä»Šæ—¥æ‰“å¡</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="dashboard-item">
                                <div id="user-count" class="dashboard-value">-</div>
                                <div class="dashboard-label">ç”¨æˆ¶æ•¸</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="dashboard-item">
                                <div id="cpu-usage" class="dashboard-value">-</div>
                                <div class="dashboard-label">CPU ä½¿ç”¨ç‡</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="system-info mt-3">
                        <div><strong>ç³»çµ±ç‰ˆæœ¬ï¼š</strong> <span id="system-version">2025.04.01</span></div>
                        <div><strong>æ›´æ–°æ™‚é–“ï¼š</strong> <span id="update-time">-</span></div>
                        <div><strong>å¹³å°ï¼š</strong> <span id="platform-info">-</span></div>
                    </div>
                </div>
            </div>
            
            <!-- ç³»çµ±æ—¥èªŒ -->
            <div class="card">
                <div class="card-header">ç³»çµ±æ—¥èªŒ</div>
                <div class="card-body">
                    <a href="/admin/logs?userId={{ user_id }}" class="btn btn-primary">æŸ¥çœ‹æ—¥èªŒ</a>
                </div>
            </div>
        </div>
        
        <!-- ç®¡ç†æ“ä½œ -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">ç®¡ç†æ“ä½œ</div>
                <div class="card-body">
                    <button id="backup-db" class="btn btn-success w-100 mb-3">
                        <i class="fas fa-database"></i> å‚™ä»½æ•¸æ“šåº«
                    </button>
                    
                    <button id="clear-cache" class="btn btn-warning w-100 mb-3">
                        <i class="fas fa-broom"></i> æ¸…ç†ç³»çµ±ç¼“å­˜
                    </button>
                    
                    <button id="reset-rich-menu" class="btn btn-info w-100 mb-3">
                        <i class="fas fa-redo"></i> é‡ç½® Rich Menu
                    </button>
                    
                    <hr>
                    
                    <div class="mt-3">
                        <label for="broadcast-message"><strong>ç™¼é€å…¨ç¾¤é€šçŸ¥ï¼š</strong></label>
                        <textarea id="broadcast-message" class="form-control mb-2" rows="3" placeholder="è¼¸å…¥è¦ç™¼é€çµ¦æ‰€æœ‰ç”¨æˆ¶çš„æ¶ˆæ¯..."></textarea>
                        <button id="send-broadcast" class="btn btn-danger w-100">
                            <i class="fas fa-bullhorn"></i> ç™¼é€é€šçŸ¥
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- çµæœæç¤ºæ¡† -->
<div class="modal fade" id="resultModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modal-title">æ“ä½œçµæœ</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="modal-message">
                æ“ä½œå·²å®Œæˆ
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">é—œé–‰</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
<script>
    // ç”¨æˆ¶ID (å¾ä¼ºæœå™¨ç«¯å‚³é)
    const userId = "{{ user_id }}";
    
    // æ›´æ–°ç³»çµ±è³‡è¨Š
    function updateSystemInfo() {
        fetch(`/api/admin/system-info?userId=${userId}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showAlert('error', data.error);
                    return;
                }
                
                // æ›´æ–°çµ±è¨ˆæ•¸æ“š
                document.getElementById('checkin-count').innerText = data.db_stats.checkin_count;
                document.getElementById('today-count').innerText = data.db_stats.today_count;
                document.getElementById('user-count').innerText = data.db_stats.user_count;
                document.getElementById('cpu-usage').innerText = data.cpu_percent + '%';
                
                // æ›´æ–°ç³»çµ±è³‡è¨Š
                document.getElementById('update-time').innerText = data.time;
                document.getElementById('platform-info').innerText = data.platform;
                
                // æ›´æ–°ç³»çµ±ç‹€æ…‹æŒ‡ç¤º
                const systemStatus = document.getElementById('system-status');
                if (data.cpu_percent > 90 || data.memory_percent > 90) {
                    systemStatus.className = 'status-badge status-danger float-right';
                    systemStatus.innerText = 'éè¼‰';
                } else if (data.cpu_percent > 70 || data.memory_percent > 70) {
                    systemStatus.className = 'status-badge status-warning float-right';
                    systemStatus.innerText = 'è² è¼‰è¼ƒé«˜';
                } else {
                    systemStatus.className = 'status-badge status-good float-right';
                    systemStatus.innerText = 'æ­£å¸¸';
                }
            })
            .catch(error => {
                console.error('ç²å–ç³»çµ±è³‡è¨Šå¤±æ•—:', error);
                showAlert('error', 'ç²å–ç³»çµ±è³‡è¨Šå¤±æ•—');
            });
    }

    // ç™¼é€å…¨ç¾¤é€šçŸ¥
    document.getElementById('send-broadcast').addEventListener('click', function() {
        const message = document.getElementById('broadcast-message').value.trim();
        
        if (!message) {
            showAlert('error', 'æ¶ˆæ¯ä¸èƒ½ç‚ºç©º');
            return;
        }
        
        fetch('/api/admin/broadcast', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                userId: userId,
                message: message 
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showModal('ç™¼é€æˆåŠŸ', 'å…¨ç¾¤é€šçŸ¥å·²ç™¼é€');
                document.getElementById('broadcast-message').value = '';
            } else {
                showModal('ç™¼é€å¤±æ•—', data.message);
            }
        })
        .catch(error => {
            console.error('ç™¼é€å…¨ç¾¤é€šçŸ¥å¤±æ•—:', error);
            showModal('ç™¼é€å¤±æ•—', 'æ“ä½œéç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤');
        });
    });
    
    // é¡¯ç¤ºæç¤ºæ¡†
    function showAlert(type, message) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        `;
        
        document.querySelector('.container').prepend(alertDiv);
        
        // è‡ªå‹•æ¶ˆå¤±
        setTimeout(() => {
            alertDiv.classList.remove('show');
            setTimeout(() => alertDiv.remove(), 150);
        }, 3000);
    }
    
    // é¡¯ç¤ºæ¨¡æ…‹æ¡†
    function showModal(title, message) {
        document.getElementById('modal-title').textContent = title;
        document.getElementById('modal-message').textContent = message;
        $('#resultModal').modal('show');
    }
    
    // å‚™ä»½æ•¸æ“šåº«
    document.getElementById('backup-db').addEventListener('click', function() {
        fetch('/api/admin/backup-db', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userId: userId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showModal('å‚™ä»½æˆåŠŸ', data.message);
            } else {
                showModal('å‚™ä»½å¤±æ•—', data.message);
            }
        })
        .catch(error => {
            console.error('å‚™ä»½æ•¸æ“šåº«å¤±æ•—:', error);
            showModal('å‚™ä»½å¤±æ•—', 'æ“ä½œéç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤');
        });
    });
    
    // æ¸…ç†ç³»çµ±ç¼“å­˜
    document.getElementById('clear-cache').addEventListener('click', function() {
        fetch('/api/admin/clear-cache', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userId: userId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showModal('æ¸…ç†æˆåŠŸ', data.message);
            } else {
                showModal('æ¸…ç†å¤±æ•—', data.message);
            }
        })
        .catch(error => {
            console.error('æ¸…ç†ç¼“å­˜å¤±æ•—:', error);
            showModal('æ¸…ç†å¤±æ•—', 'æ“ä½œéç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤');
        });
    });
    
    // é‡ç½® Rich Menu
    document.getElementById('reset-rich-menu').addEventListener('click', function() {
        fetch('/init-rich-menu')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showModal('é‡ç½®æˆåŠŸ', data.message);
                } else {
                    showModal('é‡ç½®å¤±æ•—', data.message);
                }
            })
            .catch(error => {
                console.error('é‡ç½® Rich Menu å¤±æ•—:', error);
                showModal('é‡ç½®å¤±æ•—', 'æ“ä½œéç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤');
            });
    });
    
    // é é¢åŠ è¼‰æ™‚æ›´æ–°ç³»çµ±è³‡è¨Š
    document.addEventListener('DOMContentLoaded', function() {
        updateSystemInfo();
        
        // æ¯30ç§’è‡ªå‹•æ›´æ–°ä¸€æ¬¡ç³»çµ±è³‡è¨Š
        setInterval(updateSystemInfo, 30000);
    });
</script>
{% endblock %}
