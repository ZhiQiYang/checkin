<!-- templates/logs.html -->
{% extends "base.html" %}

{% block title %}ç³»çµ±æ—¥èªŒ{% endblock %}

{% block extra_css %}
<style>
    .log-container {
        background-color: #1e1e1e;
        color: #dcdcdc;
        border-radius: 5px;
        padding: 15px;
        font-family: Consolas, Monaco, 'Courier New', monospace;
        height: 70vh;
        overflow-y: auto;
        white-space: pre-wrap;
        font-size: 0.9em;
        line-height: 1.5;
    }
    .log-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }
    .log-filter {
        margin-bottom: 15px;
        padding: 10px;
        background-color: #f5f5f5;
        border-radius: 5px;
    }
    .filter-input {
        width: 100%;
        padding: 5px;
        border: 1px solid #ccc;
        border-radius: 3px;
    }
    .log-info {
        color: #75bfff;
    }
    .log-warning {
        color: #ffcc66;
    }
    .log-error {
        color: #ff6b6b;
    }
    .timestamp {
        color: #999;
    }
    .nav-buttons {
        margin-top: 15px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="log-header">
        <h1 class="mb-0">ğŸ“‹ ç³»çµ±æ—¥èªŒ</h1>
        <div>
            <button id="refresh-btn" class="btn btn-primary">åˆ·æ–°</button>
            <button id="download-btn" class="btn btn-secondary ml-2">ä¸‹è¼‰æ—¥èªŒ</button>
        </div>
    </div>
    
    <div class="log-filter">
        <input type="text" id="log-search" class="filter-input" placeholder="è¼¸å…¥é—œéµå­—éæ¿¾æ—¥èªŒ...">
        <div class="mt-2">
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" id="show-info" checked>
                <label class="form-check-label" for="show-info">é¡¯ç¤ºä¿¡æ¯</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" id="show-warnings" checked>
                <label class="form-check-label" for="show-warnings">é¡¯ç¤ºè­¦å‘Š</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" id="show-errors" checked>
                <label class="form-check-label" for="show-errors">é¡¯ç¤ºéŒ¯èª¤</label>
            </div>
        </div>
    </div>
    
    <div class="card">
        <div class="card-body p-0">
            <div id="log-content" class="log-container">{{ log_content }}</div>
        </div>
    </div>
    
    <div class="text-muted mt-2">
        æ—¥èªŒæ–‡ä»¶: {{ log_file }} | ç”Ÿæˆæ™‚é–“: {{ generated_time }}
    </div>
    
    <div class="nav-buttons">
        <a href="/admin?userId={{ user_id }}" class="btn btn-secondary">è¿”å›ç®¡ç†é¢æ¿</a>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // æ—¥èªŒéæ¿¾åŠŸèƒ½
    document.getElementById('log-search').addEventListener('input', filterLogs);
    document.getElementById('show-info').addEventListener('change', filterLogs);
    document.getElementById('show-warnings').addEventListener('change', filterLogs);
    document.getElementById('show-errors').addEventListener('change', filterLogs);
    
    function filterLogs() {
        const searchText = document.getElementById('log-search').value.toLowerCase();
        const showInfo = document.getElementById('show-info').checked;
        const showWarnings = document.getElementById('show-warnings').checked;
        const showErrors = document.getElementById('show-errors').checked;
        
        const logContent = document.getElementById('log-content');
        const logLines = logContent.innerText.split('\n');
        let filteredContent = '';
        
        for (const line of logLines) {
            const lowerLine = line.toLowerCase();
            
            // æª¢æŸ¥æ—¥èªŒé¡å‹
            const isInfo = lowerLine.includes(' info:') && !lowerLine.includes(' warning:') && !lowerLine.includes(' error:');
            const isWarning = lowerLine.includes(' warning:');
            const isError = lowerLine.includes(' error:');
            
            // æ ¹æ“šéæ¿¾å™¨è¨­ç½®æ±ºå®šæ˜¯å¦é¡¯ç¤º
            const showByType = (isInfo && showInfo) || 
                              (isWarning && showWarnings) || 
                              (isError && showErrors) ||
                              (!isInfo && !isWarning && !isError); // å…¶ä»–é¡å‹é»˜èªé¡¯ç¤º
            
            // æ ¹æ“šæœç´¢æ–‡æœ¬éæ¿¾
            const matchesSearch = !searchText || lowerLine.includes(searchText);
            
            if (showByType && matchesSearch) {
                // æ·»åŠ é¡è‰²æ¨£å¼
                let styledLine = line;
                if (isInfo) {
                    styledLine = `<span class="log-info">${line}</span>`;
                } else if (isWarning) {
                    styledLine = `<span class="log-warning">${line}</span>`;
                } else if (isError) {
                    styledLine = `<span class="log-error">${line}</span>`;
                }
                
                // ç‚ºæ™‚é–“æˆ³æ·»åŠ æ¨£å¼
                styledLine = styledLine.replace(/\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}/g, 
                                           '<span class="timestamp">$&</span>');
                
                filteredContent += styledLine + '\n';
            }
        }
        
        logContent.innerHTML = filteredContent;
    }
    
    // é é¢åŠ è¼‰æ™‚è™•ç†æ—¥èªŒæ¨£å¼
    document.addEventListener('DOMContentLoaded', function() {
        filterLogs();
    });
    
    // åˆ·æ–°æŒ‰éˆ•
    document.getElementById('refresh-btn').addEventListener('click', function() {
        window.location.reload();
    });
    
    // ä¸‹è¼‰æ—¥èªŒæŒ‰éˆ•
    document.getElementById('download-btn').addEventListener('click', function() {
        const logContent = document.getElementById('log-content').innerText;
        const blob = new Blob([logContent], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = 'system_log_{{ generated_time|replace(":", "-")|replace(" ", "_") }}.txt';
        document.body.appendChild(a);
        a.click();
        
        setTimeout(function() {
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }, 0);
    });
</script>
{% endblock %}
