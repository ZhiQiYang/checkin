{% extends "base.html" %}

{% block title %}æ‰“å¡é é¢{% endblock %}

{% block extra_css %}
<style>
    button { padding: 10px 20px; font-size: 16px; margin-top: 10px; }
    input, textarea, select { width: 100%; margin-bottom: 10px; padding: 5px; }
    
    /* æ‰“å¡é¡å‹é¸æ“‡å™¨æ¨£å¼ */
    .checkin-type-options {
        padding: 12px;
        background-color: #f5f5f5;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    
    .radio-group {
        display: flex;
        gap: 10px;
        margin-top: 8px;
    }
    
    .radio-option {
        flex: 1;
        display: block;
        padding: 12px;
        border-radius: 6px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: bold;
    }
    
    .radio-option input[type="radio"] {
        display: none;
    }
    
    .checkin-in {
        background-color: #e3f2fd;
        color: #0d47a1;
        border: 2px solid #90caf9;
    }
    
    .checkin-out {
        background-color: #fff8e1;
        color: #ff8f00;
        border: 2px solid #ffcc80;
    }
    
    .radio-option.selected {
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        transform: translateY(-2px);
    }
    
    .checkin-in.selected {
        background-color: #bbdefb;
        border-color: #1976d2;
    }
    
    .checkin-out.selected {
        background-color: #ffe0b2;
        border-color: #f57c00;
    }
    
    /* æ‰“å¡æŒ‰éˆ•æ¨£å¼ */
    .checkin-button-in {
        background-color: #1976d2 !important;
    }
    
    .checkin-button-out {
        background-color: #f57c00 !important;
    }
</style>
{% endblock %}

{% block content %}
<h1>ğŸ“ æ‰“å¡é é¢</h1>

<div id="status-message" class="alert alert-info">æ­£åœ¨è¼‰å…¥æ‰“å¡ç‹€æ…‹...</div>

<form id="checkinForm">
  <input type="hidden" id="userId" value="">
  <input type="hidden" id="displayName" value="">

  <!-- æ‰“å¡é¡å‹é¸æ“‡ -->
  <div class="checkin-type-options">
    <label>æ‰“å¡é¡å‹ï¼š</label>
    <div class="radio-group">
      <label class="radio-option checkin-in">
        <input type="radio" name="checkinType" value="ä¸Šç­" id="checkinType-in" checked>
        <span class="radio-label">ä¸Šç­æ‰“å¡</span>
      </label>
      <label class="radio-option checkin-out">
        <input type="radio" name="checkinType" value="ä¸‹ç­" id="checkinType-out">
        <span class="radio-label">ä¸‹ç­æ‰“å¡</span>
      </label>
    </div>
  </div>

  <label>ä½ç½®åç¨±ï¼š</label>
  <input type="text" id="location" placeholder="ä¾‹å¦‚ï¼šå°ä¸­è¾¦å…¬å®¤">

  <label>å‚™è¨»ï¼ˆé¸å¡«ï¼‰ï¼š</label>
  <textarea id="note" rows="3"></textarea>

  <label>ç·¯åº¦ï¼š</label>
  <input type="text" id="latitude" readonly>

  <label>ç¶“åº¦ï¼š</label>
  <input type="text" id="longitude" readonly>

  <button type="button" onclick="getLocation()">ğŸ“ è‡ªå‹•å®šä½</button>
  <button type="button" id="submitBtn" class="checkin-button-in" onclick="submitCheckin()">âœ… ä¸Šç­æ‰“å¡</button>
</form>

<div id="status"></div>
{% endblock %}

{% block scripts %}
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
  let userId = "";
  let displayName = "";

  // åˆå§‹åŒ–LIFF
  async function initializeLiff() {
    try {
      await liff.init({ liffId: "{{ liff_id }}" });
      if (!liff.isLoggedIn()) {
        liff.login();
        return;
      }
      
      const profile = await liff.getProfile();
      userId = profile.userId;
      displayName = profile.displayName;
      
      document.getElementById("userId").value = profile.userId;
      document.getElementById("displayName").value = profile.displayName;
      
      // åŠ è¼‰å®Œæˆå¾Œï¼Œæª¢æŸ¥æ‰“å¡ç‹€æ…‹
      checkTodayCheckinStatus();
    } catch (error) {
      console.error("LIFFåˆå§‹åŒ–å¤±æ•—:", error);
      document.getElementById("status").innerHTML = `
        <div class="alert alert-danger">
          <strong>âŒ LIFFåˆå§‹åŒ–å¤±æ•—</strong>
          <p>è«‹ç¢ºä¿æ‚¨åœ¨LINEæ‡‰ç”¨ç¨‹å¼ä¸­é–‹å•Ÿæ­¤é é¢ã€‚</p>
        </div>
      `;
    }
  }

  // æª¢æŸ¥ä»Šæ—¥æ‰“å¡ç‹€æ…‹
  async function checkTodayCheckinStatus() {
    try {
      const userId = document.getElementById("userId").value;
      if (!userId) return; // å¦‚æœé‚„æ²’æœ‰ç²å–åˆ°ç”¨æˆ¶IDï¼Œå°±ä¸æª¢æŸ¥
      
      const response = await fetch(`/api/checkin/status?userId=${userId}`);
      const data = await response.json();
      
      if (data.success) {
        const statusMessage = document.getElementById("status-message");
        const statusHtml = [];
        
        // æª¢æŸ¥ä¸Šç­æ‰“å¡ç‹€æ…‹
        if (data.status['ä¸Šç­']) {
          document.getElementById("checkinType-in").disabled = true;
          statusHtml.push(`ä»Šå¤©å·²å®Œæˆä¸Šç­æ‰“å¡ï¼ˆ${data.status['ä¸Šç­']}ï¼‰`);
        }
        
        // æª¢æŸ¥ä¸‹ç­æ‰“å¡ç‹€æ…‹
        if (data.status['ä¸‹ç­']) {
          document.getElementById("checkinType-out").disabled = true;
          statusHtml.push(`ä»Šå¤©å·²å®Œæˆä¸‹ç­æ‰“å¡ï¼ˆ${data.status['ä¸‹ç­']}ï¼‰`);
        }
        
        // å¦‚æœå…©ç¨®æ‰“å¡éƒ½å®Œæˆäº†
        if (data.status['ä¸Šç­'] && data.status['ä¸‹ç­']) {
          statusMessage.className = "alert alert-success";
          statusMessage.innerHTML = `<strong>ğŸ‰ ä»Šå¤©çš„ä¸Šç­å’Œä¸‹ç­æ‰“å¡éƒ½å·²å®Œæˆï¼</strong>`;
          document.getElementById("submitBtn").disabled = true;
        } 
        // å¦‚æœä¸Šç­å·²æ‰“å¡ä½†ä¸‹ç­æœªæ‰“å¡ï¼Œè‡ªå‹•é¸æ“‡ä¸‹ç­æ‰“å¡
        else if (data.status['ä¸Šç­'] && !data.status['ä¸‹ç­']) {
          document.getElementById("checkinType-out").checked = true;
          statusMessage.className = "alert alert-info";
          statusMessage.innerHTML = `<strong>âœ… å·²å®Œæˆä¸Šç­æ‰“å¡ï¼Œå¯ä»¥é€²è¡Œä¸‹ç­æ‰“å¡</strong>`;
          updateCheckinTypeUI();
        }
        // å¦‚æœæ²’æœ‰ä¸Šç­æ‰“å¡ï¼Œç¦ç”¨ä¸‹ç­æ‰“å¡é¸é …
        else if (!data.status['ä¸Šç­']) {
          document.getElementById("checkinType-in").checked = true;
          document.getElementById("checkinType-out").disabled = true;
          statusMessage.className = "alert alert-warning";
          statusMessage.innerHTML = `<strong>âš ï¸ è«‹å…ˆå®Œæˆä¸Šç­æ‰“å¡ï¼Œæ‰èƒ½é€²è¡Œä¸‹ç­æ‰“å¡</strong>`;
          updateCheckinTypeUI();
        }
      } else {
        document.getElementById("status-message").className = "alert alert-warning";
        document.getElementById("status-message").innerHTML = `<strong>âš ï¸ ç„¡æ³•å–å¾—æ‰“å¡ç‹€æ…‹ï¼Œè«‹é‡æ–°è¼‰å…¥é é¢</strong>`;
      }
    } catch (error) {
      console.error("æª¢æŸ¥æ‰“å¡ç‹€æ…‹å¤±æ•—:", error);
      document.getElementById("status-message").className = "alert alert-danger";
      document.getElementById("status-message").innerHTML = `<strong>âŒ æª¢æŸ¥æ‰“å¡ç‹€æ…‹å¤±æ•—</strong>`;
    }
  }

  // ç²å–ä½ç½®
  function getLocation() {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        pos => {
          document.getElementById("latitude").value = pos.coords.latitude;
          document.getElementById("longitude").value = pos.coords.longitude;
          document.getElementById("status").innerHTML = `
            <div class="alert alert-success">
              <strong>âœ… å·²å–å¾—å®šä½è³‡è¨Š</strong>
            </div>
          `;
        },
        err => {
          document.getElementById("status").innerHTML = `
            <div class="alert alert-danger">
              <strong>âŒ å–å¾—å®šä½å¤±æ•—</strong>
              <p>${err.message}</p>
            </div>
          `;
        }
      );
    } else {
      document.getElementById("status").innerHTML = `
        <div class="alert alert-danger">
          <strong>âŒ ç€è¦½å™¨ä¸æ”¯æ´å®šä½åŠŸèƒ½</strong>
        </div>
      `;
    }
  }

  // æ›´æ–°æ‰“å¡é¡å‹UI
  function updateCheckinTypeUI() {
    const checkinInRadio = document.getElementById('checkinType-in');
    const checkinOutRadio = document.getElementById('checkinType-out');
    const submitBtn = document.getElementById('submitBtn');
    const inOption = document.querySelector('.checkin-in');
    const outOption = document.querySelector('.checkin-out');
    
    // ç§»é™¤æ‰€æœ‰ selected é¡åˆ¥
    inOption.classList.remove('selected');
    outOption.classList.remove('selected');
    
    // æª¢æŸ¥æ˜¯å¦å˜—è©¦é¸æ“‡ä¸‹ç­æ‰“å¡ä½†è¢«ç¦ç”¨
    if (checkinOutRadio.checked && checkinOutRadio.disabled) {
      checkinInRadio.checked = true;
    }
    
    // æ ¹æ“šé¸ä¸­çš„æ‰“å¡é¡å‹æ›´æ–°UI
    if (checkinInRadio.checked) {
      submitBtn.innerHTML = "âœ… ä¸Šç­æ‰“å¡";
      submitBtn.className = "btn btn-primary btn-lg";
      inOption.classList.add('selected');
    } else {
      submitBtn.innerHTML = "âœ… ä¸‹ç­æ‰“å¡";
      submitBtn.className = "btn btn-success btn-lg";
      outOption.classList.add('selected');
    }
  }

  // æäº¤æ‰“å¡
  function submitCheckin() {
    // ç²å–é¸ä¸­çš„æ‰“å¡é¡å‹
    const checkinType = document.querySelector('input[name="checkinType"]:checked').value;
    
    // é©—è­‰
    if (!document.getElementById("location").value.trim()) {
      document.getElementById("status").innerHTML = `
        <div class="alert alert-danger">
          <strong>âŒ è«‹è¼¸å…¥ä½ç½®åç¨±</strong>
        </div>
      `;
      return;
    }
    
    const payload = {
      userId: document.getElementById("userId").value,
      displayName: document.getElementById("displayName").value,
      location: document.getElementById("location").value,
      note: document.getElementById("note").value,
      latitude: document.getElementById("latitude").value,
      longitude: document.getElementById("longitude").value,
      checkinType: checkinType  // ä½¿ç”¨é¸ä¸­çš„æ‰“å¡é¡å‹
    };

    // æäº¤å‰ç¦ç”¨æŒ‰éˆ•
    const submitBtn = document.getElementById("submitBtn");
    submitBtn.disabled = true;
    submitBtn.innerHTML = "è™•ç†ä¸­...";

    fetch("/api/checkin", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    })
    .then(res => res.json())
    .then(data => {
      const status = document.getElementById("status");
      
      if (data.success) {
        // æˆåŠŸæ‰“å¡
        status.innerHTML = `
          <div class="alert alert-success">
            <strong>âœ… ${data.message}</strong>
            <p class="mt-2 mb-0">æ‚¨å·²å®Œæˆ${checkinType}æ‰“å¡ï¼</p>
          </div>
        `;
        
        // æ›´æ–°æ‰“å¡ç‹€æ…‹
        setTimeout(checkTodayCheckinStatus, 1000);
      } else {
        // æ‰“å¡å¤±æ•—
        status.innerHTML = `
          <div class="alert alert-danger">
            <strong>âŒ ${data.message}</strong>
          </div>
        `;
        submitBtn.disabled = false;
        submitBtn.innerHTML = `âœ… ${checkinType}æ‰“å¡`;
      }
    })
    .catch(error => {
      console.error("æ‰“å¡è«‹æ±‚å¤±æ•—:", error);
      document.getElementById("status").innerHTML = `
        <div class="alert alert-danger">
          <strong>âŒ ç¶²è·¯éŒ¯èª¤ï¼Œè«‹é‡è©¦</strong>
        </div>
      `;
      submitBtn.disabled = false;
      submitBtn.innerHTML = `âœ… ${checkinType}æ‰“å¡`;
    });
  }

  // è¨»å†Šäº‹ä»¶ç›£è½å™¨
  document.addEventListener('DOMContentLoaded', function() {
    // ç›£è½æ‰“å¡é¡å‹è®Šæ›´äº‹ä»¶
    const checkinInRadio = document.getElementById('checkinType-in');
    const checkinOutRadio = document.getElementById('checkinType-out');
    
    if (checkinInRadio && checkinOutRadio) {
      checkinInRadio.addEventListener('change', updateCheckinTypeUI);
      checkinOutRadio.addEventListener('change', updateCheckinTypeUI);
    }
    
    // åˆå§‹åŒ–
    initializeLiff();
    updateCheckinTypeUI();
  });
</script>
{% endblock %}
