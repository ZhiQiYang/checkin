{% extends "base.html" %}

{% block title %}æ‰“å¡é é¢{% endblock %}

{% block extra_css %}
<style>
    button { padding: 10px 20px; font-size: 16px; margin-top: 10px; }
    input, textarea { width: 100%; margin-bottom: 10px; padding: 5px; }
</style>
{% endblock %}

{% block content %}
<h1>ğŸ“ æ‰“å¡é é¢</h1>

<form id="checkinForm">
  <input type="hidden" id="userId" value="">
  <input type="hidden" id="displayName" value="">

  <label>ä½ç½®åç¨±ï¼š</label>
  <input type="text" id="location" placeholder="ä¾‹å¦‚ï¼šå°ä¸­è¾¦å…¬å®¤">

  <label>å‚™è¨»ï¼ˆé¸å¡«ï¼‰ï¼š</label>
  <textarea id="note" rows="3"></textarea>

  <label>ç·¯åº¦ï¼š</label>
  <input type="text" id="latitude" readonly>

  <label>ç¶“åº¦ï¼š</label>
  <input type="text" id="longitude" readonly>

  <button type="button" onclick="getLocation()">ğŸ“ è‡ªå‹•å®šä½</button>
  <button type="button" onclick="submitCheckin()">âœ… æ‰“å¡</button>
</form>

<div id="status"></div>
{% endblock %}

{% block scripts %}
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
  async function initializeLiff() {
    await liff.init({ liffId: "{{ liff_id }}" });
    if (!liff.isLoggedIn()) liff.login();
    const profile = await liff.getProfile();
    document.getElementById("userId").value = profile.userId;
    document.getElementById("displayName").value = profile.displayName;
  }

  function getLocation() {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        pos => {
          document.getElementById("latitude").value = pos.coords.latitude;
          document.getElementById("longitude").value = pos.coords.longitude;
          document.getElementById("status").innerText = "âœ… å·²å–å¾—å®šä½è³‡è¨Š";
        },
        err => {
          document.getElementById("status").innerText = "âŒ å–å¾—å®šä½å¤±æ•—";
        }
      );
    } else {
      document.getElementById("status").innerText = "âŒ ç€è¦½å™¨ä¸æ”¯æ´å®šä½åŠŸèƒ½";
    }
  }

  function submitCheckin() {
    const payload = {
      userId: document.getElementById("userId").value,
      displayName: document.getElementById("displayName").value,
      location: document.getElementById("location").value,
      note: document.getElementById("note").value,
      latitude: document.getElementById("latitude").value,
      longitude: document.getElementById("longitude").value,
    };

    fetch("/api/checkin", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    })
    .then(res => res.json())
    .then(data => {
      document.getElementById("status").innerText = data.message;
    })
    .catch(() => {
      document.getElementById("status").innerText = "âŒ ç„¡æ³•é€å‡ºæ‰“å¡ï¼Œè«‹ç¨å¾Œå†è©¦";
    });
  }

  initializeLiff();
</script>
{% endblock %}
